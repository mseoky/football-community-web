{% extends 'layout.html' %}

{% block content %}
  <div class="post-details">
    <div class="header">
      <h1>제목: {{ post.subject }}</h1>
      <p>작성자: {{ post.userNick }}</p>
      <p>
        작성일: {{ post.createdAt.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
        }) }}
      {% if post.createdAt.getTime() !== post.updatedAt.getTime() %}
        (수정일: {{ post.updatedAt.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
        }) }})
      {% endif %}
      </p>
      <p>조회수: {{ post.hit }}</p>
    </div>

    <div class="content">
      <p>내용: </p>
      {% if post.img %}
        <img src="{{ post.img }}" alt="게시글 이미지">
      {% endif %}
      <p>{{ post.content }}</p>
    </div>

    {% if user and user.id === post.userId %}
      <div class="actions">
        <!-- 수정 버튼 -->
        <a href="/post/{{ post.id }}/edit" class="edit-button" data-post-id="{{ post.id }}">수정하기</a>
        <!-- 삭제 버튼 -->
        <button class="delete-button" id="remove-btn" data-post-id="{{ post.id }}">삭제하기</button>
      </div>
    {% endif %}
  </div>
  <!-- 댓글 창 -->
  <div class="comment-section">
    <textarea id="comment-input" placeholder="댓글을 입력하세요"></textarea>
    <button id="submit-comment">작성</button>
  </div>

  <!-- 댓글 리스트 -->
  <div class="comment-list">
    {% for comment in comments %}
      <!-- 댓글 아이템 -->
      <div class="comment-item">
        <span class="comment-author">{{ comment.userNick }}</span>
        <span class="comment-content">{{ comment.comment }}</span>
        <span class="comment-date">{{ comment.createdAt.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }) }}</span>
        {% if user and user.id === comment.userId %}
          <button class="delete-comment-button" data-comment-id="{{ comment.id }}">삭제</button>
        {% endif %}
      </div>
    {% endfor %}
    </div>

  <style>
    body {
      background-color: #fff;
    }

    .post-details {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 0.5rem;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .edit-button, .delete-button {
      display: inline-block;
      padding: 5px;
      margin-top: 5px;
      margin-right: 5px;
      border-radius: 5px;
      text-decoration: none;
      color: #fff;
      font-weight: bold;
    }

    .edit-button {
      background-color: #3498db;
    }

    .delete-button {
      background-color: #ff0000;
    }
    
    /* 댓글 관련 css */

    .comment-section {
      margin-top: 20px;
      display: flex;
      margin-bottom: 20px;
    }

    #comment-input {
      flex: 1;
      padding: 8px;
      margin-right: 8px;
    }

    #submit-comment {
      padding: 8px;
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .comment-item {
    background-color: #fff;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  .comment-author {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .comment-content {
    margin-bottom: 10px;
  }

  .comment-date {
    color: #555;
    margin-right: 10px;
  }

  .delete-comment-button {
    background-color: #ff0000;
    color: #fff;
    border: none;
    padding: 5px;
    border-radius: 5px;
    cursor: pointer;
  }
  </style>
{% endblock %}

{% block script %}
  <script>
    // 게시글 삭제
    document.querySelectorAll('.delete-button').forEach(function(button) {
      button.addEventListener('click', function() {
        const postId = button.dataset.postId; // 게시글의 ID를 가져옴
        if (confirm('정말로 삭제하시겠습니까?')) {
          axios.delete(`/post/${postId}`)
            .then(() => {
              window.location.href = 'http://localhost:8080/';
            })
            .catch((err) => {
              console.error(err);
            });
        }
      });
    });
    // 댓글 작성
    document.getElementById('submit-comment').addEventListener('click', function() {
      const commentContent = document.getElementById('comment-input').value;
      const postId = "{{ post.id }}";  // 현재 게시물의 ID를 가져오기
      const userId = "{{ user.id }}";  // 현재 사용자의 ID를 가져오기

      if (!userId) {
          alert('로그인이 필요합니다.');
          return;
      }

    // 서버로 데이터 전송
    axios.post(`/post/comment`, { postId, userId, commentContent })
      .then((response) => {
        // 성공적으로 댓글을 작성한 경우 실행할 코드
        console.log('댓글 작성 성공');
        window.location.reload();
      })
      .catch((error) => {
        console.error('댓글 작성 실패', error);
      });
    });
    // 댓글 삭제
    document.querySelectorAll('.delete-comment-button').forEach(function (button) {
      button.addEventListener('click', function () {
        const commentId = button.dataset.commentId; // 댓글의 ID를 가져옴
        if (confirm('정말로 삭제하시겠습니까?')) {
          axios.delete(`/post/comment/${commentId}`)
            .then(() => {
              window.location.reload();
            })
            .catch((err) => {
              console.error(err);
            });
        }
      });
    });
  </script>
{% endblock %}